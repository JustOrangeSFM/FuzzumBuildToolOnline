name: Build Android APK

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Set up Android SDK (without NDK)
        uses: android-actions/setup-android@v3
        with:
          cmdline-tools-version: "11076708"
          packages: |
            platforms;android-33
            build-tools;33.0.2

      # ðŸ”½ Ð¡ÐºÐ°Ñ‡Ð¸Ð²Ð°ÐµÐ¼ Ð¸ ÐºÐ»Ð°Ð´Ñ‘Ð¼ NDK Ð¢ÐžÐ§ÐÐž Ñ‚ÑƒÐ´Ð°, Ð³Ð´Ðµ Ð¾Ð¶Ð¸Ð´Ð°ÐµÑ‚ BuildSettings.json
      - name: Download and place NDK to ./ndk/android-ndk-r25b
        run: |
          curl -L https://github.com/android/ndk/releases/download/ndk-r25b/android-ndk-r25b-windows.zip -o ndk.zip
          mkdir ndk
          7z x ndk.zip -ondk
        shell: cmd

      # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)
      - name: Verify NDK path
        run: dir "ndk\android-ndk-r25b\toolchains\llvm\prebuilt\windows-x86_64\bin"
        shell: cmd

      - name: Verify build files exist
        shell: cmd
        run: |
          if not exist "BuildToolCpp.exe" exit /b 1
          if not exist "[BUILD]BuildEngine[Android].bat" exit /b 1

      - name: Run Android build
        shell: cmd
        run: call "[BUILD]BuildEngine[Android].bat"

      - name: Find APK
        id: find_apk
        shell: cmd
        run: |
          for /r %%i in (*.apk) do (
            echo APK_PATH=%%i
            echo APK_PATH=%%i>>%GITHUB_ENV%
            goto :done
          )
          echo ERROR: APK not found!
          exit /b 1
          :done

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: game-apk
          path: ${{ env.APK_PATH }}

name: Build Android APK

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-2022

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Set up Android SDK (NO NDK!)
        uses: android-actions/setup-android@v3
        with:
          cmdline-tools-version: "11076708"
          packages: |
            platforms;android-33
            build-tools;33.0.2

      # ✅ Кэшируем standalone NDK по хэшу URL
      - name: Cache Standalone NDK r25b
        id: cache-ndk
        uses: actions/cache@v4
        with:
          path: ndk
          key: ndk-r25b-windows-${{ hashFiles('**/.github/workflows/build-android.yml') }}

      # ✅ Скачиваем NDK только если кэш промахнулся
      - name: Download Standalone NDK r25b
        if: steps.cache-ndk.outputs.cache-hit != 'true'
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "https://dl.google.com/android/repository/android-ndk-r25b-windows.zip" -OutFile "ndk.zip"
          mkdir ndk
          7z x ndk.zip -ondk

      # ✅ Кэшируем Gradle и Android SDK (build-tools, licenses и т.д.)
      - name: Cache Gradle and Android SDK
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            C:/Android/android-sdk
          key: android-gradle-${{ runner.os }}-${{ hashFiles('**/gradle/wrapper/gradle-wrapper.properties') }}

      # ✅ Патчим BuildSettings.json
      - name: Patch BuildSettings.json
        shell: pwsh
        run: |
          $path = "GameProject\Build\BuildSettings.json"
          if (!(Test-Path $path)) {
            Write-Error "BuildSettings.json not found!"
            exit 1
          }
          $ndkPath = "$(Get-Location)\ndk\android-ndk-r25b"
          $ndkPath = $ndkPath -replace '\\', '/'
          $json = Get-Content $path | ConvertFrom-Json
          $json.Android.NDK = $ndkPath
          $json.Android.SDK = "C:/Android/android-sdk"
          $json.Android.Java = "C:/hostedtoolcache/windows/Java_Temurin-Hotspot_jdk/17.0.17-10/x64"
          $json | ConvertTo-Json -Depth 10 | Set-Content $path
          Write-Host "Patched NDK to: $ndkPath"

      - name: Verify tools
        shell: cmd
        run: |
          if not exist "BuildToolCpp.exe" exit /b 1
          if not exist "[BUILD]BuildEngine[Android].bat" exit /b 1

      # ✅ Запускаем билд НЕИНТЕРАКТИВНО — обходим `pause`
      - name: Run Android build (non-interactive)
        shell: cmd
        run: |
          echo. | call "[BUILD]BuildEngine[Android].bat"

      - name: Find APK
        id: find_apk
        shell: cmd
        run: |
          for /r %%i in (*.apk) do (
            echo APK_PATH=%%i
            echo APK_PATH=%%i>>%GITHUB_ENV%
            goto :done
          )
          echo ERROR: APK not found!
          exit /b 1
          :done

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: game-apk
          path: ${{ env.APK_PATH }}
